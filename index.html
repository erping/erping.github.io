<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="薛定谔的喵" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="一只喵的成长之路">
<meta property="og:type" content="website">
<meta property="og:title" content="薛定谔的喵">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="薛定谔的喵">
<meta property="og:description" content="一只喵的成长之路">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="薛定谔的喵">
<meta name="twitter:description" content="一只喵的成长之路">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 薛定谔的喵 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f70194dfe3d0179dbe3b00e0a14cfc36";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">薛定谔的喵</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">成长之路</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'erpinggithubio','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/14/Python-requests/" itemprop="url">
                  Python requests
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-08-14T21:56:43+08:00" content="2016-08-14">
              2016-08-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/14/Python-requests/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/14/Python-requests/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><strong>转载请注明作者及出处，如果你觉得这篇文章对你有帮助或启发，也可以来请我<a href="http://7xp01p.com1.z0.glb.clouddn.com/1449296258436.jpg" target="_blank" rel="external">喝咖啡</a></strong></p>
<p>在日常开发测试过程中，常常需要发送一些HTTP请求，Python的Requests模块正是为此而生，她使用简单但功能却十分强大，<br>从基本的参数传递，响应解析到会话保持，设置代理应有尽有，不禁让人感叹：Life is short，use python.下面就简要介绍一些<br>常用功能，以飨读者。</p>
<ul>
<li>发送请求</li>
</ul>
<p>最简单的功能就是发送http请求，只需要一行代码,得到的response赋值给r</p>
<pre><code>r = requests.<span class="function"><span class="title">get</span><span class="params">(<span class="string">'http://www.google.com'</span>)</span></span>
</code></pre><ul>
<li>传递URL参数</li>
</ul>
<p>在url中传递参数一般是按照key/value的格式，跟在一个问号后面，如<a href="http://www.test.com/get?key=value，requests中用字典来表示参数，假如你想传递key1=value1,key2=value2到http://www.test.com/get，那么可以使用如下代码：" target="_blank" rel="external">http://www.test.com/get?key=value，requests中用字典来表示参数，假如你想传递key1=value1,key2=value2到http://www.test.com/get，那么可以使用如下代码：</a></p>
<pre><code>para = {<span class="string">'key1'</span>:<span class="string">'value1'</span>,<span class="string">'key2'</span>:<span class="string">'value'</span>}
r = requests.<span class="keyword">get</span>(<span class="string">'http://www.test.com/get'</span>,<span class="keyword">params</span> = para}
</code></pre><ul>
<li>传递POST参数</li>
</ul>
<p>跟传递URL参数类似，post数据可以存在字典中传给data参数,在发送请求时会自动编码为表单形式：</p>
<pre><code><span class="operator"><span class="keyword">load</span> = {<span class="string">'key1'</span>:<span class="string">'value1'</span>,<span class="string">'key2'</span>:<span class="string">'value2'</span>}
r = requests.post(<span class="keyword">url</span>,<span class="keyword">data</span> = <span class="keyword">load</span>)</span>
</code></pre><p>对于接受JSON格式的POST数据：</p>
<pre><code><span class="title">r</span> = requests.post(url,<span class="typedef"><span class="keyword">data</span> = json.dumps<span class="container">(<span class="title">load</span>)</span>)</span>
</code></pre><p>如果你既需要传递POST参数也需要在URL中传参，很简单，将上面两者结合即可：</p>
<pre><code><span class="title">r</span> = request.post(url,params = para,<span class="typedef"><span class="keyword">data</span> = json.dumps<span class="container">(<span class="title">load</span>)</span>)</span>
</code></pre><p>是不是so easy?</p>
<ul>
<li>响应内容</li>
</ul>
<p>对于普通内容，可以直接print r.text,request已经自动处理了解压和编码的工作，对于JSON的内容，<br>requsets中有内置的JSON解析器，可以很方便的处理JSON数据：</p>
<pre><code>url =  'http://ip.taobao.com/service/getIpInfo.php'
para = {'ip':'8.8.8.8'}
r = requests.get(url,params = para)
print r.json()[<span class="link_label">'data'</span>][<span class="link_reference">'country'</span>].encode('utf-8')
</code></pre><p>输出为美国</p>
<ul>
<li>定制头部</li>
</ul>
<p>有的网站会对头部的UA验证，如果判定是机器根本就不让访问，这时候我们就要修改请求头部的某些字段，还是老方法传个字典就行。</p>
<pre><code><span class="setting">my_headers = <span class="value">{<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36'</span>,<span class="string">'Accept-Encoding'</span>:<span class="string">'gzip'</span>}</span></span>

<span class="setting">r = <span class="value">requests.get(url,headers = my_headers)</span></span>
</code></pre><p>requests库的宣言是 HTTP for Humans（给人用的HTTP库），我觉得是做到了，没什么是一行代码搞不定的，如果有，那就写两行。此篇仅是抛砖引玉，更多用法请参考官网。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/04/scrapy入门/" itemprop="url">
                  scrapy入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-04T21:42:41+08:00" content="2016-07-04">
              2016-07-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/04/scrapy入门/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/04/scrapy入门/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><strong>转载请注明作者及出处，如果你觉得这篇文章对你有帮助或启发，也可以来请我<a href="http://7xp01p.com1.z0.glb.clouddn.com/1449296258436.jpg" target="_blank" rel="external">喝咖啡</a></strong></p>
<p>scrapy是用python写的一个爬虫框架，可以很方便的抓取网上信息。今天我们就用它来爬取小米AppStore网站上的Android app信息，来简单介绍一下用法。</p>
<p>首先新建一个Scrapy项目，我们cd到项目目录然后执行</p>
<pre><code><span class="title">scrapy</span> startproject xiaomi_appstore_crawler
</code></pre><p>就会在当前路径上生成一下目录结构（除了xiaomi_spider.py和那些pyc文件):</p>
<p>这些文件分别是</p>
<ul>
<li>scrapy.cfg:项目配置文件</li>
<li>items.py:项目items文件,数据容器</li>
<li>pipelines.py:pipelines文件，用于离线处理</li>
<li>settings.py：项目设置文件</li>
<li>spiders/:放置spider代码目录</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/03/科学上网/" itemprop="url">
                  科学上网
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-03T22:24:32+08:00" content="2016-07-03">
              2016-07-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/03/科学上网/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/03/科学上网/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><strong>转载请注明作者及出处，如果你觉得这篇文章对你有帮助或启发，也可以来请我<a href="http://7xp01p.com1.z0.glb.clouddn.com/1449296258436.jpg" target="_blank" rel="external">喝咖啡</a></strong></p>
<p>不能互联的网络还能叫互联网么，所以有人说我们不过是在一个大的局域网里罢了。不过局域网里东西逐渐丰富起来以后，很多人就满足了，丧失了探索之心，可谓夏虫不可语冰，悲哉。有的人倒是爱折腾，但是在受管制的网络环境里根本搜不到相关文章，就好像一个在围城里的人想出去，可是要出城的钥匙却放在城外一样。闲话少叙，今天就简单介绍一下如何搭一个出城的梯子。</p>
<p>目前比较好的方案是利用shadowsocks，但是前提是需要一个国外的vps，没有的话需要自己查询去购买。在Ubuntu下安装ss很方便，只需要3条命令：</p>
<pre><code>apt-get <span class="operator"><span class="keyword">update</span>
apt-<span class="keyword">get</span> <span class="keyword">install</span> python-pip
pip <span class="keyword">install</span> shadowsocks</span>
</code></pre><p>上述命令最好在root权限下输入，如果执行完毕并且没有报错的话，安装就算是成功了，接下来就是配置文件了。</p>
<p>在/etc目录下写一个名为shadowsocks.json的文件，里面内容如下：</p>
<pre><code>{
"<span class="attribute">server</span>":<span class="value"><span class="string">"0.0.0.0"</span></span>,
"<span class="attribute">server_port</span>":<span class="value"><span class="number">8388</span></span>,
"<span class="attribute">local_address</span>": <span class="value"><span class="string">"127.0.0.1"</span></span>,
"<span class="attribute">local_port</span>":<span class="value"><span class="number">1080</span></span>,
"<span class="attribute">password</span>":<span class="value"><span class="string">"mypassword"</span></span>,
"<span class="attribute">timeout</span>":<span class="value"><span class="number">300</span></span>,
"<span class="attribute">method</span>":<span class="value"><span class="string">"aes-256-cfb"</span></span>,
"<span class="attribute">fast_open</span>": <span class="value"><span class="literal">false</span>
</span>}
</code></pre><p>需要注意的一点就是server对应的值，很多教程里写的是server的ip，但是我那样却报错了，查到资料说改为0.0.0.0,如果你的vps支持ipv6，这里可以改为两个冒号::表示支持双栈协议，很多大学里可以用ipv6并且一般是不收网费的，这样你就可以利用ss上网不花钱啦。</p>
<p>配置文件写完以后需要运行起来，很简单一条命令：</p>
<pre><code>ssserver -c /etc/shadowsocks<span class="class">.json</span> -d start
</code></pre><p>如果你想服务器开机自动启动ss，需要把这条命令写入/etc/rc.local文件最后一行就行，至此服务器这边算是完成了。</p>
<p>在linux下客户端跟服务器差不多，也需要前面的下载ss，配置文件里不同的一点就是server对应的值为vps的ip地址，然后启动命令为</p>
<pre><code>sslocal -c <span class="regexp">/etc/</span>shadowsocks.json
</code></pre><p>windos下有GUI的客户端，可以在这<a href="http://pan.baidu.com/s/1mhWTTag" title="下载" target="_blank" rel="external">下载</a>，然后下载chrome浏览器插件switchsharp，做简单配置即可。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/05/Linux-CGroup/" itemprop="url">
                  Linux CGroup
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-06-05T20:05:28+08:00" content="2016-06-05">
              2016-06-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/05/Linux-CGroup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/05/Linux-CGroup/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><strong>转载请注明作者及出处，如果你觉得这篇文章对你有帮助或启发，也可以来请我<a href="http://7xp01p.com1.z0.glb.clouddn.com/1449296258436.jpg" target="_blank" rel="external">喝咖啡</a></strong></p>
<p>Linux CGroup全称Linux Control Group， 是Linux内核的一个功能，用来限制，控制与分离一个进程组群的资源（如CPU、内存、磁盘输入输出等），这也是时下火热的docker的基础技术之一。</p>
<p>Linux CGroupCgroup 可​​​让​​​您​​​为​​​系​​​统​​​中​​​所​​​运​​​行​​​任​​​务​​​（进​​​程​​​）的​​​用​​​户​​​定​​​义​​​组​​​群​​​分​​​配​​​资​​​源​​​ — 比​​​如​​​ CPU 时​​​间​​​、​​​系​​​统​​​内​​​存​​​、​​​网​​​络​​​带​​​宽​​​或​​​者​​​这​​​些​​​资​​​源​​​的​​​组​​​合​​​。​​​您​​​可​​​以​​​监​​​控​​​您​​​配​​​置​​​的​​​ cgroup，拒​​​绝​​​ cgroup 访​​​问​​​某​​​些​​​资​​​源​​​，甚​​​至​​​在​​​运​​​行​​​的​​​系​​​统​​​中​​​动​​​态​​​配​​​置​​​您​​​的​​​ cgroup。</p>
<p>其主要提供了以下功能：</p>
<ol>
<li><strong>Resource limitation</strong>: 限制资源使用，比如内存使用上限以及文件系统的缓存限制。</li>
<li><strong>Prioritization</strong>：优先级控制，比如：CPU利用和磁盘IO吞吐。</li>
<li><strong>Accounting</strong>：一些审计或一些统计，主要目的是为了计费。</li>
<li><strong>Control</strong>：挂起进程，恢复执行进程。</li>
</ol>
<p>安装也很简单，Linux将其实现为一个文件系统，在Ubuntu 14.04下输入以下命令即可：</p>
<pre><code>spring@ubuntu:~<span class="variable">$mount</span> -t cgroup
</code></pre><p>然后我们在/sys/fs下就可以看到一个cgroup目录，这个目录下还有很多子目录，比如： cpu，cpuset，memory，blkio……这些，这些都是cgroup的子系统，分别用于控制不同的资源。你可以到/sys/fs/cgroup的各个子目录里去创建目录，然后进入创建的目录后发现里面又有很多文件了。</p>
<pre><code>spring<span class="variable">@ubuntu</span><span class="symbol">:/sys/fs/cgroup/cpu</span><span class="variable">$ </span>sudo mkdir test
[sudo] password <span class="keyword">for</span> <span class="symbol">spring:</span> 
spring<span class="variable">@ubuntu</span><span class="symbol">:/sys/fs/cgroup/cpu</span><span class="variable">$ </span>ls ./test
cgroup.clone_children  cgroup.procs       cpu.cfs_quota_us  cpu.stat    tasks
cgroup.event_control   cpu.cfs_period_us  cpu.shares        notify_on_release
</code></pre><p>下面我们看几个例子来直观感受一下</p>
<ul>
<li><strong>CPU限制</strong></li>
</ul>
<p>我们先写一个非常耗费CPU的程序</p>
<p>deadloop.c</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    <span class="keyword">int</span> i = <span class="number">0</span>;
    <span class="keyword">while</span>(<span class="number">1</span>)
        i++;
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>然后编译执行</p>
<pre><code>spring<span class="variable">@ubuntu</span><span class="symbol">:~</span><span class="variable">$gcc</span> -o deadloop deadloop.c
spring<span class="variable">@ubuntu</span><span class="symbol">:~</span><span class="variable">$.</span>/deadloop
</code></pre><p>利用top观察CPU利用情况，CPU马上到接近100%</p>
<pre><code>PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM   TIME+ COMMAND     
<span class="number">2273</span> root      <span class="number">20</span>   <span class="number">0</span>    <span class="number">2020</span>    <span class="number">280</span>   <span class="number">228</span> R <span class="number">99.6</span>  <span class="number">0.1</span>   <span class="number">0</span>:<span class="number">23.13</span> deadloop
</code></pre><p>这时候我们就可以利用CGroup里的cpu来限制使用：</p>
<pre><code><span class="label">root@ubuntu:</span>~# echo <span class="number">20000</span> &gt; /sys/<span class="literal">fs</span>/cgroup/<span class="built_in">cpu</span>/<span class="keyword">test</span>/<span class="built_in">cpu</span>.cfs_quota_us
</code></pre><p>进程的ID为2273，我们将其加入到CGroup</p>
<pre><code># echo <span class="number">2273</span> &gt;&gt; <span class="regexp">/sys/</span>fs<span class="regexp">/cgroup/</span>cpu<span class="regexp">/test/</span>tasks
</code></pre><p>再top查看cpu利用马上降到20%</p>
<pre><code>PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM   TIME+ COMMAND     
<span class="number">2273</span> root      <span class="number">20</span>   <span class="number">0</span>    <span class="number">2020</span>    <span class="number">280</span>   <span class="number">228</span> R <span class="number">19.6</span>  <span class="number">0.1</span>   <span class="number">0</span>:<span class="number">32.43</span> deadloop
</code></pre><ul>
<li><strong>内存限制</strong></li>
</ul>
<p>同样我们写一个不断分配内存的死循环：</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span>
<span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span>

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>
</span>{
    <span class="keyword">int</span> size = <span class="number">0</span>;
    <span class="keyword">int</span> chunk_size = <span class="number">512</span>;
    <span class="keyword">void</span> *p = <span class="literal">NULL</span>;

    <span class="keyword">while</span>(<span class="number">1</span>) {

        <span class="keyword">if</span> ((p = <span class="built_in">malloc</span>(p, chunk_size)) == <span class="literal">NULL</span>) {
            <span class="built_in">printf</span>(<span class="string">"out of memory!!\n"</span>);
            <span class="keyword">break</span>;
        }
        <span class="built_in">memset</span>(p, <span class="number">1</span>, chunk_size);
        size += chunk_size;
        <span class="built_in">printf</span>(<span class="string">"[%d] - memory is allocated [%8d] bytes \n"</span>, getpid(), size);
        sleep(<span class="number">1</span>);
    }
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>然后利用CGroup进行限制：</p>
<pre><code><span class="variable">$ </span>mkdir /sys/fs/cgroup/memory/test
<span class="variable">$ </span>echo <span class="number">64</span>k &gt; <span class="regexp">/sys/fs</span><span class="regexp">/cgroup/memory</span><span class="regexp">/test/memory</span>.limit_in_bytes
<span class="variable">$ </span>echo pid &gt; <span class="regexp">/sys/fs</span><span class="regexp">/cgroup/memory</span><span class="regexp">/haoel/tasks</span>
</code></pre><p>一会就能看到上面的进程因为内存分配问题被kill掉。</p>
<p>除了cpu和memory以外还有blkio-为​​​块​​​设​​​备​​​设​​​定​​​输​​​入​​​/输​​​出​​​限​​​制​​​，比​​​如​​​物​​​理​​​设​​​备​​​（磁​​​盘​​​，固​​​态​​​硬​​​盘​​​，USB 等​​​等​​​），cpuset- cgroup 中​​​的​​​任​​​务​​​分​​​配​​​独​​​立​​​ CPU（在​​​多​​​核​​​系​​​统​​​）和​​​内​​​存​​​节​​​点,devices-允​​​许​​​或​​​者​​​拒​​​绝​​​ cgroup 中​​​的​​​任​​​务​​​访​​​问​​​设​​​备,freezer-挂​​​起​​​或​​​者​​​恢​​​复​​​ cgroup 中​​​的​​​任​​​务，还有net_cls、net_prio等等，想具体了解可以网上查阅相关资料。</p>
<p>参考：1.<a href="http://coolshell.cn/articles/17049.html" target="_blank" rel="external">http://coolshell.cn/articles/17049.html</a><br>2.<a href="http://xiezhenye.com/2013/10/%E7%94%A8-cgroups-%E7%AE%A1%E7%90%86-cpu-%E8%B5%84%E6%BA%90.html" target="_blank" rel="external">http://xiezhenye.com/2013/10/%E7%94%A8-cgroups-%E7%AE%A1%E7%90%86-cpu-%E8%B5%84%E6%BA%90.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/06/LVS集群体系架构/" itemprop="url">
                  LVS集群体系架构
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-05-06T16:25:29+08:00" content="2016-05-06">
              2016-05-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/06/LVS集群体系架构/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/06/LVS集群体系架构/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><strong>转载请注明作者及出处，如果你觉得这篇文章对你有帮助或启发，也可以来请我<a href="http://7xp01p.com1.z0.glb.clouddn.com/1449296258436.jpg" target="_blank" rel="external">喝咖啡</a></strong></p>
<ul>
<li><strong>引言</strong></li>
</ul>
<p>互联网在近十几年发展迅猛，已经成为人们生活中密不可分的一部分，大型网站的PV常常过亿，这对网站体系架构提出挑战。因为系统必须是高性能，高可靠的，尤其当访问负载不断增长时，系统必须能被扩展来满足不断增长的性能需求。现在后台服务器一般都是集群的方式，需要利用负载均衡的技术将请求分发到集群中，负载均衡的方式一般有LVS，Nginx和HAproxy，今天主要说一下LVS的体系结构。</p>
<ul>
<li><strong>LVS通用体系结构</strong></li>
</ul>
<p>LVS集群采用IP负载均衡技术和基于内容请求分发技术。调度器具有很好的吞吐率，将请求均衡地转移到不同的服务器上执行，且调度器自动屏蔽掉服 务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器。整个服务器集群的结构对客户是透明的，而且无需修改客户端和服务器端的程序。<br><img src="http://7xp01p.com1.z0.glb.clouddn.com/LVS.png" alt=""></p>
<p>一般来说，LVS集群采用三层结构，其体系结构如上图所示，三层主要组成部分为：</p>
<ol>
<li><strong>负载调度器</strong>（load balancer），它是整个集群对外面的前端机，负责将客户的请求发送到一组服务器上执行，而客户认为服务是来自一个IP地址（我们可称之为虚拟IP地址）上的。</li>
<li><strong>服务器池</strong>（server pool），是一组真正执行客户请求的服务器，执行的服务有WEB、MAIL、FTP和DNS等。</li>
<li><strong>共享存储</strong>（shared storage），它为服务器池提供一个共享的存储区，这样很容易使得服务器池拥有相同的内容，提供相同的服务。</li>
</ol>
<p>调度器是服务器集群系统的唯一入口点，它可以采用IP负载均衡技术、基于内容请求分发技术或者两者相结合。在IP负载均衡技术中，需要服务器池拥有相同的内容提供相同的服务。当 客户请求到达时，调度器只根据服务器负载情况和设定的调度算法从服务器池中选出一个服务器，将该请求转发到选出的服务器，并记录这个调度；当这个请求的其 他报文到达，也会被转发到前面选出的服务器。在基于内容请求分发技术中，服务器可以提供不同的服务，当客户请求到达时，调度器可根据请求的内容选择服务器 执行请求。因为所有的操作都是在Linux操作系统核心空间中将完成的，它的调度开销很小，所以它具有很高的吞吐率。</p>
<p>服务器池的结点数目是可变的。当整个系统收到的负载超过目前所有结点的处理能力时，可以在服务器池中增加服务器来满足不断增长的请求负载。对大多数 网络服务来说，请求间不存在很强的相关性，请求可以在不同的结点上并行执行，所以整个系统的性能基本上可以随着服务器池的结点数目增加而线性增长。</p>
<p>共享存储通常是数据库、网络文件系统或者分布式文件系统。服务器结点需要动态更新的数据一般存储在数据库系统中，同时数据库会保证并发 访问时数据的一致性。分布式文件系统可为各服务器提供共享的存储区，它们访问分布式文件系统就像访问本地文件系统一样，同时分布式文件系统可提 供良好的伸缩性和可用性。</p>
<ul>
<li><strong>系统优点</strong></li>
</ul>
<p>LVS采用以上的系统架构使得其有很多优点：</p>
<p> <strong>层次体系结构</strong></p>
<p>层次的体系结构可以使得层与层之间相互独立，每一个层次提供不同的功能，在一个层次可以重用不同的已有软件。例如，调度器层提供了负载平衡、可伸缩 性和高可用性等，在服务器层可以运行不同的网络服务，如Web、Cache、Mail和Media等，来提供不同的可伸缩网络服务。明确的功能划分和清晰 的层次结构使得系统容易建设，以后整个系统容易维护，而且系统的性能容易被扩展。</p>
<p> <strong>共享存储</strong></p>
<p>共享存储如分布式文件系统在这个LVS集群系统是可选项。当网络服务需要有相同的内容，共享存储是很好的选择，否则每台服务器需要将相同的 内容复制到本地硬盘上。当系统存储的内容越多，这种无共享结构的代价越大，因为每台服务器需要一样大的存储空间，任何的更新需要涉及到每台服务器，系统的维护代价会非常高。</p>
<p>共享存储为服务器组提供统一的存储空间，这使得系统的内容维护工作比较轻松，如Webmaster只需要更新共享存储中的页面，对所有 的服务器都有效。分布式文件系统提供良好的伸缩性和可用性，当分布式文件系统的存储空间增加时，所有服务器的存储空间也随之增大。对于大多数 Internet服务来说，它们都是读密集型的应用，分布式文件系统在每台服务器使用本地硬盘作Cache（如 2Gbytes的空间），可以使得访问分布式文件系统本地的速度接近于访问本地硬盘。</p>
<p> <strong>高可用性</strong></p>
<p>集群系统的特点是它在软硬件上都有冗余。系统的高可用性可以通过检测节点或服务进程故障和正确地重置系统来实现，使得系统收到的请求能被存活的结点处理。</p>
<p>通常，我们在调度器上有资源监测进程来时刻监视各个服务器结点的健康状况。当服务器对ICMP ping不可达时或者探测她的网络服务在指定的时间没有响应时，资源监测进程通知操作系统内核将该服务器从调度列表中删除或者失效。这样，新的服务请求就 不会被调度到坏的结点。资源监测进程能通过电子邮件或传呼机向管理员报告故障。一旦监测进程到服务器恢复工作，通知调度器将其加入调度列表进行调度。另 外，通过系统提供的管理程序，管理员可发命令随时可以将新机器加入服务来提高系统的处理性能，也可以将已有的服务器切出服务，以便对服务器进行系统维护。</p>
<p>现在前端的调度器有可能成为系统的单一失效点（Single Point of Failure）。一般来说，调度器的可靠性较高，因为调度器上运行的程序较少而且大部分程序早已经遍历过，但我们不能排除硬件老化、网络线路或者人为误 操作等主要故障。为了避免调度器失效而导致整个系统不能工作，我们需要设立一个从调度器作为主调度器的备份。两个心跳（Heartbeat）进程[6]分 别在主、从调度器上运行，它们通过串口线和UDP等心跳线来相互定时地汇报各自的健康状况。当从调度器不能听得主调度器的心跳时，从调度器通过ARP欺骗 （Gratuitous ARP）来接管集群对外的Virtual IP Address，同时接管主调度器的工作来提供负载调度服务。当主调度器恢复时，这里有两种方法，一是主调度器自动变成从调度器，二是从调度器释放 Virtual IP Address，主调度器收回Virtual IP Address并提供负载调度服务。这里，多条心跳线可以使得因心跳线故障导致误判（即从调度器认为主调度器已经失效，其实主调度器还在正常工作）的概论 降到最低。</p>
<p>通常，当主调度器失效时，主调度器上所有已建立连接的状态信息将丢失，已有的连接会中断。客户需要向重新连接，从调度器才会将新连接调 度到各个服务器上，这对客户会造成一定的不便。为此，IPVS调度器在Linux 内核中实现一种高效状态同步机制，将主调度器的状态信息及时地同步到从调度器。当从调度器接管时，绝大部分已建立的连接会持续下去。</p>
<p>参考：<a href="http://www.linuxvirtualserver.org/zh/lvs2.html" target="_blank" rel="external">http://www.linuxvirtualserver.org/zh/lvs2.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/qisimiao.jpg" alt="erping" itemprop="image"/>
          <p class="site-author-name" itemprop="name">erping</p>
        </div>
        <p class="site-description motion-element" itemprop="description">一只喵的成长之路</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">20</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/erping" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">erping</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"erpinggithubio"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
